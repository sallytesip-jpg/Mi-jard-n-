<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cultivo Pro ‚Äî Futurista LITE v3 (Tiempo)</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --accent:#10b981; --shadow:0 20px 60px -24px rgba(2,6,23,.25);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  header{position:sticky;top:0;background:#fffccf; border-bottom:1px solid var(--line);z-index:5}
  .max{max-width:980px;margin:0 auto;padding:10px 12px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:36px;height:36px;border-radius:12px;background:var(--accent);display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:0 10px 30px -12px rgba(16,185,129,.6)}
  .muted{color:var(--muted)}
  .wrap{max-width:980px;margin:10px auto 88px;padding:0 12px}
  .grid{display:grid;gap:12px}
  @media(min-width:780px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
  h2{margin:0 0 8px 0}
  .pill{display:inline-block;background:rgba(16,185,129,.12);color:#065f46;padding:4px 8px;border-radius:999px;font-size:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  /* Weather */
  .weather{display:grid;grid-template-columns:1fr;gap:8px}
  .w-head{display:flex;align-items:center;justify-content:space-between}
  .w-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .wday{background:#ffffff;border:1px solid var(--line);border-radius:12px;padding:8px;text-align:center}
  .wday .ico{font-size:20px}
  .wday .d{font-weight:700}
  .warn{color:#b45309} .danger{color:#b91c1c}
  /* Tabs inferior */
  .tabbar{position:fixed;bottom:0;left:0;right:0;z-index:6}
  .tabwrap{max-width:980px;margin:12px auto;background:#ffffff;border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow)}
  .tabgrid{display:grid;grid-template-columns:repeat(6,1fr)}
  .tabbtn{padding:10px 6px;display:flex;flex-direction:column;gap:2px;align-items:center;color:var(--muted);font-size:12px;font-weight:700;background:transparent;border:0}
  .tabbtn.active{color:var(--ink)}
  .view{display:none} .view.active{display:block}
</style>
</head>
<body>
<header>
  <div class="max">
    <div class="brand">
      <div class="logo">CP</div>
      <div>
        <div style="font-weight:800">Cultivo Pro</div>
        <div class="muted" style="font-size:12px">Futurista LITE v3 ¬∑ con pron√≥stico de lluvia en La Bisbal del Pened√®s</div>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- Dashboard con tiempo -->
  <section id="v-dashboard" class="view active">
    <div class="grid">
      <div class="card">
        <div class="w-head">
          <h2>üåßÔ∏è Tiempo ¬∑ La Bisbal del Pened√®s</h2>
          <div id="rainAdvice" class="pill">Cargando‚Ä¶</div>
        </div>
        <div class="muted" style="font-size:12px;margin:4px 0">Max/M√≠n, % lluvia, suma mm ¬∑ Pr√≥ximos 7 d√≠as</div>
        <div id="weather" class="weather">
          <div id="wgrid" class="w-grid"></div>
          <div class="muted" style="font-size:12px">Fuente: Open‚ÄëMeteo (sin clave). Se actualiza al abrir.</div>
        </div>
      </div>

      <div class="card">
        <h2>üìÖ Pr√≥ximas tareas</h2>
        <div id="proxTareas"></div>
      </div>

      <div class="card">
        <h2>üß™ √öltimos EC/pH</h2>
        <div id="ultimosReg"></div>
      </div>
    </div>
  </section>

  <!-- Placeholder de otras vistas (reutiliza tu LITE v2 si lo deseas) -->
  <section id="v-otros" class="view">
    <div class="card">
      <h2>Secciones</h2>
      <p>Integra aqu√≠ tus vistas de Gelato, A√ßa√≠, Exterior, Limoneros, etc.</p>
    </div>
  </section>
</main>

<nav class="tabbar">
  <div class="tabwrap">
    <div class="tabgrid">
      <button class="tabbtn active" data-tab="dashboard">üè†<span>Inicio</span></button>
      <button class="tabbtn" data-tab="otros">üß≠<span>Secciones</span></button>
      <button class="tabbtn" data-tab="otros">üåø<span>Gelato</span></button>
      <button class="tabbtn" data-tab="otros">üçá<span>A√ßa√≠</span></button>
      <button class="tabbtn" data-tab="otros">‚òÄÔ∏è<span>Exterior</span></button>
      <button class="tabbtn" data-tab="otros">üçã<span>Limoneros</span></button>
    </div>
  </div>
</nav>

<script>
/* ===== Datos dummy para tarjetas (puedes conectar con tu storage) ===== */
document.getElementById('proxTareas').innerHTML = '<div class="muted">Crea tareas en tus vistas y aparecer√°n aqu√≠.</div>';
document.getElementById('ultimosReg').innerHTML = '<div class="muted">A√±ade registros EC/pH en tus vistas.</div>';

/* ===== Navegaci√≥n ===== */
function show(tab){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('v-'+tab).classList.add('active');
  document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.tabbtn[data-tab="${tab}"]`).classList.add('active');
}
document.querySelectorAll('.tabbtn').forEach(b=> b.addEventListener('click', ()=> show(b.dataset.tab)));

/* ====== Pron√≥stico Open‚ÄëMeteo (sin API key) ======
   Coordenadas aprox La Bisbal del Pened√®s: 41.29 N, 1.44 E
   Endpoints: https://api.open-meteo.com/v1/forecast
*/
const LAT = 41.29, LON = 1.44, TZ = Intl.DateTimeFormat().resolvedOptions().timeZone || "Europe/Madrid";
const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max&timezone=${encodeURIComponent(TZ)}`;

const WICON = (code)=>{
  // Simple mapping WMO code -> emoji
  const sun='‚òÄÔ∏è', cloud='‚õÖ', rain='üåßÔ∏è', storm='‚õàÔ∏è', snow='‚ùÑÔ∏è', fog='üå´Ô∏è';
  if([0].includes(code)) return sun;
  if([1,2,3].includes(code)) return cloud;
  if([45,48].includes(code)) return fog;
  if([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) return rain;
  if([95,96,99].includes(code)) return storm;
  if([71,73,75,77,85,86].includes(code)) return snow;
  return cloud;
};

async function loadWeather(){
  try{
    const res = await fetch(url);
    const j = await res.json();
    const d = j.daily;
    const days = d.time.map((t,i)=>({
      date: t,
      code: d.weathercode[i],
      tmax: d.temperature_2m_max[i],
      tmin: d.temperature_2m_min[i],
      pr: d.precipitation_probability_max[i],
      mm: d.precipitation_sum[i]
    }));
    // Pintar 7 d√≠as
    const wgrid = document.getElementById('wgrid');
    wgrid.innerHTML = days.map(x=>`
      <div class="wday">
        <div class="d">${new Date(x.date).toLocaleDateString('es-ES',{weekday:'short'})}</div>
        <div class="ico">${WICON(x.code)}</div>
        <div>${Math.round(x.tmax)}¬∞ / ${Math.round(x.tmin)}¬∞</div>
        <div class="${x.pr>=60?'danger': x.pr>=30?'warn':''}">${x.pr}%</div>
        <div class="${x.mm>=5?'danger': x.mm>=1?'warn':''}">${x.mm.toFixed(1)} mm</div>
      </div>
    `).join('');

    // Consejo de riego seg√∫n lluvia pr√≥xima (hoy/ma√±ana)
    const today = days[0], tomorrow = days[1];
    let msg = 'Sin lluvia relevante. Mant√©n tu plan de riego.';
    if((today.pr>=60||tomorrow.pr>=60) || (today.mm>=3 || tomorrow.mm>=3)){
      msg = 'Prob. lluvia alta (24‚Äì48h). ‚ö†Ô∏è Reduce o pospone riego.';
    } else if((today.pr>=30||tomorrow.pr>=30) || (today.mm>=1 || tomorrow.mm>=1)){
      msg = 'Puede llover algo. üî∂ Ajusta riego y vigila drenaje.';
    }
    document.getElementById('rainAdvice').textContent = msg;
  }catch(e){
    document.getElementById('wgrid').innerHTML = '<div class="muted">No se pudo cargar el tiempo ahora.</div>';
    document.getElementById('rainAdvice').textContent = 'Reintenta m√°s tarde';
  }
}
loadWeather();
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cultivo Pro ‚Äî Futurista</title>
  <meta name="theme-color" content="#0ea5a4" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: { DEFAULT:'#10b981'} },
          boxShadow: {
            glow: '0 10px 40px -10px rgba(16,185,129,.45)',
            soft: '0 20px 60px -24px rgba(2,6,23,.25)',
          }
        }
      }
    }
  </script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@0.471.0/dist/umd/lucide.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* Fondo aurora */
    .aurora {
      position: fixed; inset: -20% -10% auto -10%; height: 40vh; z-index: -1;
      background: radial-gradient(40% 60% at 20% 30%, rgba(16,185,129,.35), transparent 60%),
                  radial-gradient(30% 50% at 80% 20%, rgba(59,130,246,.25), transparent 60%),
                  radial-gradient(25% 45% at 60% 70%, rgba(99,102,241,.20), transparent 60%);
      filter: blur(40px); animation: drift 18s ease-in-out infinite alternate;
    }
    @keyframes drift { from { transform: translateY(0px) } to { transform: translateY(30px) } }
    .tab-hidden { display: none !important; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 via-slate-50 to-white text-slate-900 selection:bg-emerald-100 selection:text-slate-900">
  <div class="aurora"></div>

  <!-- Header -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/70 border-b border-slate-200">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-2xl bg-emerald-500 text-white grid place-items-center shadow-glow">
          <i data-lucide="sprout" class="w-5 h-5"></i>
        </div>
        <div>
          <div class="font-bold tracking-tight">Cultivo Pro</div>
          <div class="text-xs text-slate-500">UI Futurista ¬∑ Offline-first</div>
        </div>
      </div>
      <div class="hidden sm:flex items-center gap-2 text-xs text-slate-500">
        <span id="pwa-state">PWA: listo</span>
        <span class="px-2">‚Ä¢</span>
        <button id="btn-install" class="hidden rounded-lg px-2 py-1 ring-1 ring-slate-200">Instalar</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-5xl px-4 pb-24 pt-4">
    <!-- DASHBOARD -->
    <section id="tab-dashboard">
      <div class="grid gap-4 md:grid-cols-2">
        <div class="rounded-3xl bg-white/90 ring-1 ring-slate-200 shadow-soft p-5">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="list-checks" class="w-5 h-5"></i> Pr√≥ximas tareas</h2>
            <span class="text-xs text-slate-500">Vista global</span>
          </div>
          <div id="proxTareas" class="flex flex-col gap-2"></div>
        </div>
        <div class="rounded-3xl bg-white/90 ring-1 ring-slate-200 shadow-soft p-5">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="activity" class="w-5 h-5"></i> √öltimos EC/pH</h2>
            <span class="text-xs text-slate-500">Resumen</span>
          </div>
          <div id="ultimosReg"></div>
        </div>

        <div class="rounded-3xl bg-white/90 ring-1 ring-slate-200 shadow-soft p-5 md:col-span-2">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="line-chart" class="w-5 h-5"></i> Gr√°fica EC/pH</h2>
            <div class="text-xs text-slate-500">
              <select id="chart-cultivo" class="rounded-lg border px-2 py-1">
                <option value="gelato">Gelato</option>
                <option value="acai">A√ßa√≠</option>
                <option value="exterior">Exterior</option>
                <option value="limoneros">Limoneros</option>
              </select>
            </div>
          </div>
          <canvas id="chart" height="140"></canvas>
        </div>
      </div>
    </section>

    <!-- SECCIONES -->
    <section id="tab-gelato" class="tab-hidden"></section>
    <section id="tab-acai" class="tab-hidden"></section>
    <section id="tab-exterior" class="tab-hidden"></section>
    <section id="tab-limoneros" class="tab-hidden"></section>
    <section id="tab-notas" class="tab-hidden">
      <div class="rounded-3xl bg-white/90 ring-1 ring-slate-200 shadow-soft p-5">
        <h2 class="text-lg font-semibold mb-2 flex items-center gap-2"><i data-lucide="sticky-note" class="w-5 h-5"></i> Notas globales</h2>
        <textarea id="notas-global" class="w-full rounded-xl border p-3" placeholder="Escribe ideas, compras, tareas generales‚Ä¶"></textarea>
        <div class="mt-2 text-xs text-slate-500">Se guarda autom√°ticamente en este dispositivo.</div>
      </div>
    </section>
  </main>

  <!-- Tab bar inferior -->
  <nav class="fixed bottom-0 left-0 right-0 z-50">
    <div class="mx-auto max-w-5xl m-3 rounded-2xl bg-white/90 ring-1 ring-slate-200 shadow-glow backdrop-blur">
      <div class="grid grid-cols-5">
        <button data-tab="dashboard" class="tabbtn py-3 flex flex-col items-center gap-1 text-xs font-medium text-slate-600">
          <i data-lucide="home" class="w-5 h-5"></i><span>Inicio</span>
        </button>
        <button data-tab="gelato" class="tabbtn py-3 flex flex-col items-center gap-1 text-xs font-medium text-slate-600">
          <i data-lucide="leaf" class="w-5 h-5"></i><span>Gelato</span>
        </button>
        <button data-tab="acai" class="tabbtn py-3 flex flex-col items-center gap-1 text-xs font-medium text-slate-600">
          <i data-lucide="flower" class="w-5 h-5"></i><span>A√ßa√≠</span>
        </button>
        <button data-tab="exterior" class="tabbtn py-3 flex flex-col items-center gap-1 text-xs font-medium text-slate-600">
          <i data-lucide="sun" class="w-5 h-5"></i><span>Exterior</span>
        </button>
        <button data-tab="limoneros" class="tabbtn py-3 flex flex-col items-center gap-1 text-xs font-medium text-slate-600">
          <i data-lucide="citrus" class="w-5 h-5"></i><span>Limoneros</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Bot√≥n flotante para Notas -->
  <button id="fab-notas" title="Notas" class="fixed bottom-24 right-6 rounded-full bg-emerald-500 text-white p-4 shadow-glow hover:scale-105 transition">
    <i data-lucide="pen-line" class="w-5 h-5"></i>
  </button>

  <script>
    /* ---------- Utilidad de estado ---------- */
    const KEY = (k)=>`cultivoFuturista:${k}`;
    const load = (k,def)=>{ try { const v = localStorage.getItem(KEY(k)); return v? JSON.parse(v): def; } catch { return def; } };
    const save = (k,v)=> localStorage.setItem(KEY(k), JSON.stringify(v));

    const CULTIVOS = [
      { id:'gelato',    titulo:'Gelato (Interior)',  icon:'leaf',    emoji:'üåø' },
      { id:'acai',      titulo:'A√ßa√≠ (Interior)',    icon:'flower',  emoji:'üçá' },
      { id:'exterior',  titulo:'Exterior',           icon:'sun',     emoji:'‚òÄÔ∏è' },
      { id:'limoneros', titulo:'Limoneros',          icon:'citrus',  emoji:'üçã' }
    ];

    // Inicializa estructuras
    CULTIVOS.forEach(c=>{
      if(!load(c.id+':tasks')) save(c.id+':tasks', []);
      if(!load(c.id+':gal'))   save(c.id+':gal', []);
      if(!load(c.id+':regs'))  save(c.id+':regs', []);
      if(!load(c.id+':notas')) save(c.id+':notas', '');
    });

    // Crear secciones de cultivo
    function cultivoHTML(c){
      return `
      <div class="grid gap-4 md:grid-cols-2">
        <div class="rounded-3xl bg-white/90 ring-1 ring-slate-200 shadow-soft p-5">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="check-square" class="w-5 h-5"></i> ${c.titulo} ¬∑ Tareas</h2>
            <button onclick="quickSeed('${c.id}')" class="rounded-lg px-2 py-1 text-xs ring-1 ring-slate-200">+ sugerencia</button>
          </div>
          <div class="flex flex-wrap gap-2">
            <input id="${c.id}-task-text" class="w-full sm:w-auto flex-1 rounded-xl border p-2" placeholder="A√±adir tarea‚Ä¶">
            <input id="${c.id}-task-date" type="date" class="rounded-xl border p-2">
            <button class="rounded-xl bg-slate-900 px-3 py-2 text-sm text-white" onclick="addTask('${c.id}')">A√±adir</button>
          </div>
          <div id="${c.id}-tasks" class="mt-3 flex flex-col gap-2"></div>
        </div>

        <div class="rounded-3xl bg-white/90 ring-1 ring-slate-200 shadow-soft p-5">
          <h2 class="text-lg font-semibold mb-2 flex items-center gap-2"><i data-lucide="camera" class="w-5 h-5"></i> Galer√≠a</h2>
          <input type="file" accept="image/*" multiple onchange="addImages(event,'${c.id}')" />
          <div id="${c.id}-gal" class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2"></div>
          <p class="text-xs text-slate-500 mt-1">Se guarda localmente (puede ocupar espacio).</p>
        </div>

        <div class="rounded-3xl bg-white/90 ring-1 ring-slate-200 shadow-soft p-5 md:col-span-2">
          <h2 class="text-lg font-semibold mb-2 flex items-center gap-2"><i data-lucide="test-tube" class="w-5 h-5"></i> Registros EC / pH</h2>
          <div class="flex flex-wrap gap-2">
            <input id="${c.id}-ec" type="number" step="0.01" class="rounded-xl border p-2" placeholder="EC (mS/cm)">
            <input id="${c.id}-ph" type="number" step="0.01" class="rounded-xl border p-2" placeholder="pH">
            <button class="rounded-xl bg-slate-900 px-3 py-2 text-sm text-white" onclick="addRegistro('${c.id}')">Guardar</button>
            <button class="rounded-xl bg-white px-3 py-2 text-sm ring-1 ring-slate-200" onclick="borrarRegistros('${c.id}')">Borrar</button>
          </div>
          <table class="mt-3 w-full text-sm">
            <thead><tr><th class="text-left py-1">Fecha</th><th class="text-left py-1">EC</th><th class="text-left py-1">pH</th></tr></thead>
            <tbody id="${c.id}-tabla"></tbody>
          </table>
        </div>

        <div class="rounded-3xl bg-white/90 ring-1 ring-slate-200 shadow-soft p-5 md:col-span-2">
          <h2 class="text-lg font-semibold mb-2 flex items-center gap-2"><i data-lucide="sticky-note" class="w-5 h-5"></i> Notas</h2>
          <textarea id="${c.id}-notas" class="w-full rounded-xl border p-3" placeholder="Observaciones, dosis, problemas‚Ä¶"></textarea>
          <div class="mt-2 text-xs text-slate-500">Auto-guardado activado.</div>
        </div>
      </div>`;
    }

    document.getElementById('tab-gelato').innerHTML   = cultivoHTML(CULTIVOS[0]);
    document.getElementById('tab-acai').innerHTML     = cultivoHTML(CULTIVOS[1]);
    document.getElementById('tab-exterior').innerHTML = cultivoHTML(CULTIVOS[2]);
    document.getElementById('tab-limoneros').innerHTML= cultivoHTML(CULTIVOS[3]);

    /* ---------- Tab bar ---------- */
    function setActiveTab(id){
      document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('tab-hidden'));
      document.getElementById('tab-'+id)?.classList.remove('tab-hidden');
      document.querySelectorAll('.tabbtn').forEach(b=> b.classList.remove('text-emerald-600'));
      document.querySelector(`.tabbtn[data-tab="${id}"]`)?.classList.add('text-emerald-600');
      if(id==='dashboard') renderDashboard();
      // Re-render secciones
      const c = CULTIVOS.find(x=>x.id===id);
      if(c){ renderTasks(id); renderGal(id); renderRegs(id); bindNotas(id); }
      if(id==='notas'){ bindNotasGlobal(); }
    }

    // Botones de tab bar
    document.querySelectorAll('.tabbtn').forEach(b=> b.addEventListener('click', ()=>{
      const id = b.getAttribute('data-tab');
      setActiveTab(id);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }));

    // FAB Notas
    document.getElementById('fab-notas').addEventListener('click', ()=> setActiveTab('notas'));

    /* ---------- Tareas ---------- */
    function addTask(id){
      const text = document.getElementById(id+'-task-text').value.trim();
      const date = document.getElementById(id+'-task-date').value;
      if(!text) return alert('Escribe la tarea');
      const list = load(id+':tasks', []);
      list.push({ text, date, done:false, ts:Date.now() });
      save(id+':tasks', list);
      document.getElementById(id+'-task-text').value='';
      document.getElementById(id+'-task-date').value='';
      renderTasks(id); renderDashboard();
      navigator.vibrate?.(15);
    }
    function toggleTask(id, idx){
      const list = load(id+':tasks', []);
      list[idx].done = !list[idx].done;
      save(id+':tasks', list);
      renderTasks(id); renderDashboard();
      navigator.vibrate?.(10);
    }
    function delTask(id, idx){
      const list = load(id+':tasks', []);
      list.splice(idx,1);
      save(id+':tasks', list);
      renderTasks(id); renderDashboard();
    }
    function renderTasks(id){
      const cont = document.getElementById(id+'-tasks');
      if(!cont) return;
      const list = load(id+':tasks', []);
      cont.innerHTML = list.length ? list
        .sort((a,b)=>(a.date||'9999').localeCompare(b.date||'9999'))
        .map((t,i)=>`
          <div class="flex items-center justify-between gap-2 rounded-xl border p-3 ${t.done?'opacity-60 line-through':''}">
            <div class="text-sm"><b>${t.text}</b><br><span class="text-xs text-slate-500">${t.date||'Sin fecha'}</span></div>
            <div class="flex gap-2">
              <button class="rounded-lg px-3 py-1 text-xs ring-1 ring-slate-200" onclick="toggleTask('${id}',${i})">${t.done?'Desmarcar':'Hecho'}</button>
              <button class="rounded-lg px-3 py-1 text-xs text-white bg-rose-500" onclick="delTask('${id}',${i})">Borrar</button>
            </div>
          </div>`).join('')
        : '<div class="text-sm text-slate-500">Sin tareas.</div>';
    }
    function quickSeed(id){
      const presets = {
        gelato: 'Luz 85% ¬∑ 50 cm ¬∑ medir drenaje',
        acai: 'UV‚ÄëB 1h hoy ¬∑ revisar puntas',
        exterior: 'Micorrizas + Trichoderma 1 g/4 L ¬∑ pH 6.4',
        limoneros: 'Neem 3 ml/L + Jab√≥n 1 ml/L (tarde)'
      };
      document.getElementById(id+'-task-text').value = presets[id] || '';
    }

    /* ---------- Galer√≠a ---------- */
    function addImages(ev,id){
      const files = Array.from(ev.target.files||[]);
      const gal = load(id+':gal', []);
      const jobs = files.map(f=> new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(f); }));
      Promise.all(jobs).then(imgs=>{ save(id+':gal',[...imgs, ...gal].slice(0,200)); renderGal(id); });
      ev.target.value='';
    }
    function delImg(id, idx){
      const gal = load(id+':gal', []);
      gal.splice(idx,1); save(id+':gal',gal); renderGal(id);
    }
    function renderGal(id){
      const cont = document.getElementById(id+'-gal');
      if(!cont) return;
      const gal = load(id+':gal', []);
      cont.innerHTML = gal.length ? gal.map((src,i)=>`
        <div class="relative overflow-hidden rounded-xl border">
          <img src="${src}" class="h-28 w-full object-cover" alt="foto">
          <button class="absolute right-2 top-2 rounded-md bg-rose-500 px-2 py-1 text-xs text-white" onclick="delImg('${id}',${i})">Borrar</button>
        </div>`).join('') : '<div class="text-sm text-slate-500">Sin fotos a√∫n.</div>';
    }

    /* ---------- Registros ---------- */
    function addRegistro(id){
      const ec = parseFloat(document.getElementById(id+'-ec').value);
      const ph = parseFloat(document.getElementById(id+'-ph').value);
      if(isNaN(ec)||isNaN(ph)) return alert('Completa EC y pH');
      const regs = load(id+':regs', []);
      regs.unshift({ ec, ph, fecha: new Date().toISOString().slice(0,10) });
      save(id+':regs', regs.slice(0,120));
      document.getElementById(id+'-ec').value='';
      document.getElementById(id+'-ph').value='';
      renderRegs(id); renderDashboard(); updateChart();
    }
    function borrarRegistros(id){
      if(!confirm('¬øBorrar todos los registros?')) return;
      save(id+':regs',[]); renderRegs(id); renderDashboard(); updateChart();
    }
    function renderRegs(id){
      const tbody = document.getElementById(id+'-tabla');
      if(!tbody) return;
      const regs = load(id+':regs', []);
      tbody.innerHTML = regs.map(r=> `<tr><td class="py-1">${r.fecha}</td><td class="py-1">${r.ec}</td><td class="py-1">${r.ph}</td></tr>`).join('');
    }

    /* ---------- Notas ---------- */
    function bindNotas(id){
      const ta = document.getElementById(id+'-notas');
      if(!ta) return;
      ta.value = load(id+':notas','');
      ta.oninput = ()=> save(id+':notas', ta.value);
    }
    function bindNotasGlobal(){
      const ta = document.getElementById('notas-global');
      if(!ta) return;
      ta.value = load('notasGlobal','');
      ta.oninput = ()=> save('notasGlobal', ta.value);
    }

    /* ---------- Dashboard ---------- */
    function renderDashboard(){
      const all = CULTIVOS.flatMap(c=> load(c.id+':tasks',[]).map(t=> ({...t, cultivo:c.titulo, icon:c.icon})));
      const prox = all.filter(t=>!t.done).sort((a,b)=>(a.date||'9999').localeCompare(b.date||'9999')).slice(0,8);
      document.getElementById('proxTareas').innerHTML = prox.length
        ? prox.map(t=>`<div class="rounded-xl border p-3 bg-white/70">
            <div class="text-sm font-semibold">${t.text}</div>
            <div class="text-xs text-slate-500 flex items-center gap-2 mt-1">
              <i data-lucide="${t.icon}" class="w-4 h-4"></i> ${t.cultivo} ¬∑ ${t.date||'Sin fecha'}
            </div>
          </div>`).join('')
        : '<div class="text-sm text-slate-500">No hay tareas pr√≥ximas.</div>';

      const ul = CULTIVOS.flatMap(c=> (load(c.id+':regs',[])[0] ? [{cultivo:c.titulo, ...load(c.id+':regs',[])[0]}] : []));
      document.getElementById('ultimosReg').innerHTML = ul.length
        ? '<table class="w-full text-sm"><thead><tr><th class="text-left py-1">Cultivo</th><th class="text-left py-1">Fecha</th><th class="text-left py-1">EC</th><th class="text-left py-1">pH</th></tr></thead><tbody>'
          + ul.map(r=>`<tr><td class="py-1">${r.cultivo}</td><td class="py-1">${r.fecha}</td><td class="py-1">${r.ec}</td><td class="py-1">${r.ph}</td></tr>`).join('')
          + '</tbody></table>'
        : '<div class="text-sm text-slate-500">A√∫n no hay registros.</div>';

      lucide.createIcons();
    }

    /* ---------- Chart ---------- */
    const ctx = document.getElementById('chart');
    let chart;
    function updateChart(){
      const sel = document.getElementById('chart-cultivo').value;
      const regs = load(sel+':regs',[]).slice(0,15).reverse();
      const labels = regs.map(r=>r.fecha);
      const ec = regs.map(r=>r.ec);
      const ph = regs.map(r=>r.ph);
      const data = {
        labels,
        datasets: [
          { label:'EC', data: ec, yAxisID:'y', borderWidth:2, tension:.25 },
          { label:'pH', data: ph, yAxisID:'y1', borderWidth:2, borderDash:[6,4], tension:.25 },
        ]
      };
      if(chart){ chart.data = data; chart.update(); return; }
      chart = new Chart(ctx, {
        type: 'line',
        data,
        options: {
          interaction:{ mode:'index', intersect:false },
          plugins:{ legend:{ display:true } },
          scales:{
            y: { position:'left', suggestedMin:0.4, suggestedMax:2.2 },
            y1:{ position:'right', suggestedMin:5.5, suggestedMax:6.8, grid:{ drawOnChartArea:false } }
          }
        }
      });
    }
    document.getElementById('chart-cultivo').addEventListener('change', updateChart);

    /* ---------- PWA install (si ya tienes manifest y sw en tu repo) ---------- */
    let deferredPrompt=null;
    const btnInstall = document.getElementById('btn-install');
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt=e; btnInstall?.classList.remove('hidden');
    });
    btnInstall?.addEventListener('click', async ()=>{
      if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; btnInstall.classList.add('hidden');
    });

    /* ---------- Start ---------- */
    window.addEventListener('load', ()=>{
      // Arranque: dashboard
      setActiveTab('dashboard');
      // Notas globales
      bindNotasGlobal();
      // Semillas iniciales si no hay
      if(!load('seededFuturista', false)){
        const ext = load('exterior:tasks', []);
        ext.push({ text:'Micorrizas + Trichoderma 1 g/4 L ¬∑ pH 6.4', date:new Date(Date.now()+3*864e5).toISOString().slice(0,10), done:false });
        save('exterior:tasks', ext);
        const lim = load('limoneros:tasks', []);
        lim.push({ text:'Neem 3 ml/L + Jab√≥n pot√°sico 1 ml/L (tarde)', date:new Date(Date.now()+4*864e5).toISOString().slice(0,10), done:false });
        save('limoneros:tasks', lim);
        save('seededFuturista', true);
      }
      updateChart();
      lucide.createIcons();
    });
  </script>
</body>
</html>
